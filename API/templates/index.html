<p>This is the latest output: <span id="latest"></span></p>
<p>This is all the output:</p>
<ul id="output"></ul>
<script>
  var latest = document.getElementById("latest");
  var output = document.getElementById("output");

  var xhr = new XMLHttpRequest();
  xhr.open("GET", "/stream_sqrt");

  // not helping!
  xhr.setRequestHeader("Access-Control-Allow-Origin", "http://localhost:5000"); //设置允许跨域的域名，需要发送cookie信息，所以此处需要指定具体的域名，
  xhr.setRequestHeader(
    "Access-Control-Allow-Headers",
    "Origin, X-Requested-With, Content-Type, Accept"
  );
  xhr.setRequestHeader(
    "Access-Control-Allow-Methods",
    "GET, PUT, DELETE, POST"
  ); //允许跨域的请求方式

  xhr.send();
  var position = 0;

  function handleNewData() {
    // the response text include the entire response so far
    // split the messages, then take the messages that haven't been handled yet
    // position tracks how many messages have been handled
    // messages end with a newline, so split will always show one extra empty message at the end
    var messages = xhr.responseText.split("\n");
    messages.slice(position, -1).forEach(function (value) {
      latest.textContent = value; // update the latest value in place
      // build and append a new item to a list to log all output
      var item = document.createElement("li");
      item.textContent = value;
      output.appendChild(item);
      console.log(xhr.responseText);
      console.log(xhr.readyState);
    });
    position = messages.length - 1;
    console.log("haiya");
  }

  var timer;
  var i = 0;
  timer = setInterval(function () {
    // check the response for new data
    // handleNewData();

    console.log(i);
    i = i + 1;
    console.log(xhr.readyState);
    console.log(xhr.responseText);

    if (xhr.readyState == 1) {
      console.log(xhr.responseText);
    }

    // stop checking once the response has ended
    if (xhr.readyState == XMLHttpRequest.DONE) {
      clearInterval(timer);
      latest.textContent = "Done";
    }
  }, 100);
</script>
